<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Paypal-payments by Novadge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Paypal-payments</h1>
      <h2 class="project-tagline">Accept and process payments with Paypal SDK</h2>
      <a href="https://github.com/Novadge/paypal-payments" class="btn">View on GitHub</a>
      <a href="https://github.com/Novadge/paypal-payments/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Novadge/paypal-payments/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="paypal-payments" class="anchor" href="#paypal-payments" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>paypal payments</h1>

<p>Accept and process payments with Paypal REST Api</p>

<h3>
<a id="introduction-to-paypal-payments-plugin" class="anchor" href="#introduction-to-paypal-payments-plugin" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction to Paypal payments plugin.</h3>

<p>The Paypal payments plugin simplifies the integration of Paypal into Grails applications. With this plugin, you are not required to be a Paypal sdk guru in order to accept payments.</p>

<p>This guide documents how to use the paypal payments plugin to process payments for Grails Applications. </p>

<h3>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting Started</h3>

<p>I will assume that you already have your Grails application designed and ready to accept payments. A demo application will be sufficient for this exercise.  </p>

<h4>
<a id="create-a-paypal-account" class="anchor" href="#create-a-paypal-account" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a paypal account</h4>

<p>You will need to create a paypal account and obtain API keys for a Paypal app. The Paypal app will represent your Grails application. To create a paypal app, please visit <a href="Paypal%20developer%20page">https://developer.paypal.com/developer/applications/</a> to create a sandbox account. </p>

<p>The Sandbox account will allow you to play around with most of the API features available. It is also a good way to test your application integration before moving over to a live environment. </p>

<h4>
<a id="obtain-your-client-id-and-client-secret" class="anchor" href="#obtain-your-client-id-and-client-secret" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Obtain your client id and client secret</h4>

<p>Obtain the API keys for your sandbox account/app and add it to your grails config file [Config.groovy for grails 2.x and application.groovy for grails 3.x]. Here's what my config file looks like: 
    paypal.email="<a href="mailto:omasiri@novadge.com">omasiri@novadge.com</a>"
    paypal.clientId = 'your client id'
    paypal.sandbox.clientId = 'your client id'
    paypal.clientSecret = 'your client secret'
    paypal.sandbox.clientSecret ='your client secret'
    paypal.endpoint = "<a href="https://api.paypal.com">https://api.paypal.com</a>"
    paypal.sandbox.endpoint = "<a href="https://api.sandbox.paypal.com">https://api.sandbox.paypal.com</a>"</p>

<p>`</p>

<p>Notice that I added config for sandbox and live environment. The reason is to be able to switch between both environments  during app development. </p>

<h4>
<a id="create-a-grails-controller-and-add-required-actions" class="anchor" href="#create-a-grails-controller-and-add-required-actions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a grails controller and add required actions</h4>

<p>Create a grails controller. Personally, I called my own controller PaypalController.</p>

<p><code>grails create-controller com.mypackage.Paypal
</code></p>

<h4>
<a id="add-required-actions" class="anchor" href="#add-required-actions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Add required actions</h4>

<p>Normally, Paypal payments requires three steps to complete.
1. Make approval request to paypal.
2. Approval - Customer approves the payment
3. Execution - Process response from Paypal in order to capture the payment.</p>

<h3>
<a id="approval-step" class="anchor" href="#approval-step" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Approval Step</h3>

<p>For the approval step, here's my action inside my PaypalController . 
Inject paypalService into your controller like this...</p>

<p><code>def paypalService</code></p>

<p>And then create your Controller action 
`
    import com.paypal.base.Constants; </p>

<pre><code>def approve(){


    String clientId = grailsApplication.config.paypal.clientId
    String clientSecret = grailsApplication.config.paypal.clientSecret
    String endpoint = grailsApplication.config.paypal.endpoint
    Map sdkConfig = [:] 
    sdkConfig.put(Constants.CLIENT_ID,clientId)
    sdkConfig.put(Constants.CLIENT_SECRET,clientSecret)
    sdkConfig.put(Constants.ENDPOINT,endpoint)
    def accessToken = paypalService.getAccessToken(clientId,clientSecret,sdkConfig)
    def apiContext = paypalService.getAPIContext(accessToken,sdkConfig)

    def details = paypalService.createDetails(['subtotal':"12.50"])
    def amount = paypalService.createAmount(['currency':currencyCode,'total':"12.50",'details':details])

    def transaction = paypalService.createTransaction(['amount':amount,'description':"your description",details:details])
    def transactions = []
    transactions.add(transaction)

    def payer = paypalService.createPayer(['paymentMethod':'paypal'])
    def cancelUrl="http://myexampleurl/cancel";
    def returnUrl = "http://mypaypalController/execute";

    def redirectUrls = paypalService.createRedirectUrls(['cancelUrl':cancelUrl,'returnUrl':returnUrl])


    def payment
    try{
        // create the paypal payment
        payment = paypalService.createPayment(['payer':payer,'intent':'sale'
                ,'transactionList':transactions,'redirectUrls':redirectUrls
                ,'apiContext':apiContext])



    }
    catch(Exception ex){
        String msg = ex.getMessage()
        flash.message = "Could not complete the transaction because: ${msg? msg : ''}"  

        redirect controller:'bill', action:"show",id:params['refId']
        return
    }

    def approvalUrl = ""
    def retUrl = ""
    // retrieve links from returned paypal object
    payment?.links.each{ 
        if(it?.rel == 'approval_url'){
            approvalUrl = it.href
        }
        if(it?.rel == 'return_url'){
            retUrl = it.href

        }
    }


    redirect url:approvalUrl? approvalUrl:'/', method:'POST'

}
</code></pre>

<p>`</p>

<h3>
<a id="approval" class="anchor" href="#approval" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Approval</h3>

<p>The customer will be redirected to the Paypal website for approval. After the customer approves or 
cancels the payment, Paypal will either call the returnUrl or cancelUrl you provided depending on 
what action the customer performs. </p>

<pre><code>def execute(){

    String clientId = grailsApplication.config.paypal.clientId
    String clientSecret = grailsApplication.config.paypal.clientSecret
    String endpoint = grailsApplication.config.paypal.endpoint
    Map sdkConfig = [:] //= grailsApplication.config.paypal.sdkConfig//['mode':'live']
    //sdkConfig.put("grant-type","client_credentials")
    sdkConfig.put(Constants.CLIENT_ID,clientId)
    sdkConfig.put(Constants.CLIENT_SECRET,clientSecret)
    sdkConfig.put(Constants.ENDPOINT,endpoint)
    def accessToken = paypalService.getAccessToken(clientId,clientSecret,sdkConfig)
    def apiContext = paypalService.getAPIContext(accessToken,sdkConfig)
    //the paypal website will add params to the call to your app. Eg. PayerId, PaymentId
    // you will use the params to 'execute' the payment
    def paypalPayment = paypalService.createPaymentExecution(['paymentId':params.paymentId,'payerId':params?.PayerID],apiContext)

    JsonSlurper slurper = new JsonSlurper()
    def map = slurper.parseText(paypalPayment.toString())

    redirect(url:"to your url")
}
</code></pre>

<h3>
<a id="other-things-you-can-do" class="anchor" href="#other-things-you-can-do" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Other things you can do</h3>

<p>You may perform payouts and other kinds of paypal transactions with this plugin. </p>

<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>Omasirichukwu Joseph Udeinya (<a href="https://github.com/omasiri" class="user-mention">@omasiri</a>) </p>

<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>Please feel free to reach out to us for assistance with this plugin and weâ€™ll help you sort it out.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Novadge/paypal-payments">Paypal-payments</a> is maintained by <a href="https://github.com/Novadge">Novadge</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
